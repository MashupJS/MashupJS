mashupApp.service("detectService",["$http","$q","$log","$interval","$filter","$rootScope","utility","sessionService",function(a,b,c,d,e,f,g,h){"use strict";!function(){var a=new ydn.db.Storage("logServiceDB"),b=!1;a.onReady(function(){b=!0,console.log("logServiceDB is ready. [detectService]")});var d=1008e4,e=6048e5;setInterval(function(){!function d(){if(b){var f=(new Date).getTime()-e,i=ydn.db.KeyRange.upperBound(f,!0),j=g.getLogObject("detectManagement:Truncate","Mashup.UI.Core","detectService","anonymous:setInterval",null,h);a.remove("heartbeat",i).done(function(a){j.status=!0,j.count=a,c.log("Truncating old [heartbeat] records.",j)}).fail(function(a){throw j.status=!1,c.log("Truncating old [heartbeat] records. (failed)",j),a})}else setTimeout(d,500)}()},d,0,!1)}(),f.heartBeatMonitorList=[];var i=h.envSession(),j=3e5;i.batteryLevel&&i.batteryLevel<=30&&(j=2*j),d(function(){_.each(f.heartBeatMonitorList,function(b){var c=!0;a.get(b.url,{withCredentials:!0}).success(function(a){c=!0,b.detected=c,k(b.id,c,a)}).error(function(){c=!1,b.detected=c,k(b.id,c),l(b)})})},j,0,!1);var k=function(a,b,d){var f=e("date")((new Date).getTime(),"short"),i="The heartbeat result for '"+a+"' is: [ "+b+" ] at "+f,j=g.getLogObject("HeartBeat","Mashup.UI.Core","detectService","recordHeartBeatResult",b,h);b?(j.msg=i,console.info(angular.fromJson(j))):(j.subject="HeartBeatFail",c.error("HeartBeatFail: "+i,j))},l=function(a){if(!_.where(f.codeBlueList,{id:a.id}).length&&(f.codeBlueList.push(a),!m)){var b=g.getLogObject("StartCodeBlueMonitor","Mashup.UI.Core","detectService","addToCodeBlueList","Starting",h);c.info("Starting up code Blue monitor from heartbeat monitor.",b),n()}};f.codeBlueList=[];var m,n=function(){var b=6e4;i.batteryLevel&&i.batteryLevel<=30&&(b=3*b),m=d(function(){var b=e("date")((new Date).getTime(),"short");if(0===f.codeBlueList.length){d.cancel(m),m=!1;var i=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","startCodeBlueMonitor","ended",h);c.info("codeBlueMonitor ended "+b,i)}else _.each(f.codeBlueList,function(b){var c=!0;a.get(b.url,{withCredentials:!0}).success(function(a){c=!0,b.detected=c,o(b.id,c,a),f.codeBlueList=_.filter(f.codeBlueList,function(a){return a.id!==b.id})}).error(function(){c=!1,b.detected=c,o(b.id,c)})})},b,0,!1)},o=function(a,b,d){var f=e("date")((new Date).getTime(),"short"),i="The code Blue result for "+a+" is: [ "+b+" ] at "+f,j=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","recordCodeBlueResult",b,h);j.webApiName=a,b?c.info(i,j):c.error(i,j)},p=function(a,b){if(!a)return!0;try{var d=_.where(f.heartBeatMonitorList,{id:b});if(0===d.length){var e={id:b,url:a,detected:!0};return f.heartBeatMonitorList.push(e),!0}return d[0].detected}catch(i){var j=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","canDetectHeartBeat","Error",h);j.webApiName=b,j.heartBeatUrl=a,j.error=i,c.error("detectService.canDetectHeartBeat: "+i,j)}return!0};return{detect:function(a,b){return p(a,b)},failed:function(a,b){var d=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","detectService.failed",!1,h);if(d.webApiName=b,d.heartBeatUrl=a,c.warn("detectService.failed: A call to Web Api: "+b+" failed",d),!_.where(f.codeBlueList,{id:b}).length){var e={id:b,url:a,detected:!1};f.codeBlueList.push(e)}m||n()}}}]);
//# sourceMappingURL=detect.service.min.js.map