mashupApp.service("cacheService",["$http","$q","$log","utility","detectService","sessionService",function(a,b,c,d,e,f){"use strict";var g=new ydn.db.Storage("mashCacheDB"),h=!1;g.onReady(function(){h=!0,console.log("mashCacheDB is ready.  [cacheService]")});var i=function(a,c){var d=b.defer(),e=!0,i=60*c*1e3,j=f.envSession();j.batteryLevel&&j.batteryLevel<=30&&(i=4*i);var k=(new Date).getTime();return function l(){if(h)try{g.executeSql("SELECT * FROM mashCacheAge WHERE id = '"+a+"'").then(function(a){var b=a.length;if(b>0){var c=k-a[0].updatedDate;e=c>i?!0:!1,d.resolve(e)}else d.resolve(!0)})}catch(b){d.resolve(!0)}else setTimeout(l,500)}(),d.promise},j=function(a){var b={id:a,updatedDate:(new Date).getTime()};g.put({name:"mashCacheAge",keyPath:"id"},b)},k=function(a){var c=b.defer();return function d(){if(h)try{g.executeSql("SELECT * FROM '"+a+"'").then(function(a){c.resolve("N"===a?"":a)})}catch(b){c.resolve("NoCache")}else setTimeout(d,500)}(),c.promise},l=10080;i("mashCacheStart",l).then(function(a){if(a){try{g.clear()}catch(b){}var e=d.getLogObject("mashCasheDelete","Mashup.UI.Core","cacheService","root of cacheService","Stale-Cache",f);c.log("mashCacheDB was stale so deleted.",e),j("mashCacheStart")}});var m=function(a,b,e){var g="";if(b===!0)return g=n(a);if(!e){var h=d.getLogObject("No heartBeatUrl provided","Mashup.UI.Core","cacheService","getHeartBeatUrl","return blank",f);c.warn("useHeartBeatConvention was falsy but no heartBeatUrl provided.",h)}return e},n=function(a){var b="",c=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,d=c.exec(a);return b=d[1]+":"+d[2]+d[3]+":"+d[4]+"/api/HeartBeat/"};return{dbCache:g,putCache:function(a,b,c){g.put(b,c),j(a)},getCache:function(a){var c=b.defer();return k(a).then(function(a){c.resolve(a)},function(a){c.reject()}),c.promise},getData:function(h,l,n,o,p,q,r){var s=b.defer();return q=m(n,p,q),i(h,o).then(function(b){r=r||q,r=r||n;var i=e.detect(q,r);b&&i?a.get(n,{withCredentials:!0}).success(function(a){try{g.put(l,a),j(h)}catch(b){var e=d.getLogObject("mashCasheDelete","Mashup.UI.Core","cacheService","getData","Error",f);c.error(b,e),indexedDB.deleteDatabase("mashCacheDB"),c.log("IndexedDB error on updating a cache. Deleted database to allow new schema.",e)}s.resolve(a)}).error(function(){e.failed(q,r),k(h).then(function(a){s.resolve(a)})}):k(h).then(function(a){s.resolve(a)})}),s.promise}}}]);
//# sourceMappingURL=cache.service.min.js.map