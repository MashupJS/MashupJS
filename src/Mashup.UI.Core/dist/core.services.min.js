mashupApp.service("coreDataService",["$http","$q","$log","cacheService",function(a,b,c,d){"use strict";return{getCache:function(a){var c=b.defer();return d.getCache(a).then(function(a){c.resolve(a)}),c.promise}}}]),mashupApp.factory("alertService",["$rootScope",function(a){"use strict";var b={};return a.alerts=[],b.add=function(c,d){a.alerts.push({type:c,msg:d,close:function(){b.closeAlert(this)}})},b.closeAlert=function(c){b.closeAlertIdx(a.alerts.indexOf(c))},b.closeAlertIdx=function(b){a.alerts.splice(b,1)},b}]),mashupApp.factory("Base64",function(){"use strict";var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return{encode:function(b){var c,d,e,f,g,h="",i="",j="",k=0;do c=b.charCodeAt(k++),d=b.charCodeAt(k++),i=b.charCodeAt(k++),e=c>>2,f=(3&c)<<4|d>>4,g=(15&d)<<2|i>>6,j=63&i,isNaN(d)?g=j=64:isNaN(i)&&(j=64),h=h+a.charAt(e)+a.charAt(f)+a.charAt(g)+a.charAt(j),c=d=i="",e=f=g=j="";while(k<b.length);return h},decode:function(b){var c,d,e,f,g,h="",i="",j="",k=0,l=/[^A-Za-z0-9\+\/\=]/g;l.exec(b)&&alert("There were invalid base64 characters in the input text.\nValid base64 characters are A-Z, a-z, 0-9, '+', '/',and '='\\nExpect errors in decoding."),b=b.replace(/[^A-Za-z0-9\+\/\=]/g,"");do e=a.indexOf(b.charAt(k++)),f=a.indexOf(b.charAt(k++)),g=a.indexOf(b.charAt(k++)),j=a.indexOf(b.charAt(k++)),c=e<<2|f>>4,d=(15&f)<<4|g>>2,i=(3&g)<<6|j,h+=String.fromCharCode(c),64!==g&&(h+=String.fromCharCode(d)),64!==j&&(h+=String.fromCharCode(i)),c=d=i="",e=f=g=j="";while(k<b.length);return h}}}),mashupApp.service("cacheService",["$http","$q","$log","utility","detectService","sessionService",function(a,b,c,d,e,f){"use strict";var g=new ydn.db.Storage("mashCacheDB"),h=!1;g.onReady(function(){h=!0,console.log("mashCacheDB is ready.  [cacheService]")});var i=function(a,c){var d=b.defer(),e=!0,i=60*c*1e3,j=f.envSession();j.batteryLevel&&j.batteryLevel<=30&&(i=4*i);var k=(new Date).getTime();return function l(){if(h)try{g.executeSql("SELECT * FROM mashCacheAge WHERE id = '"+a+"'").then(function(a){var b=a.length;if(b>0){var c=k-a[0].updatedDate;e=c>i?!0:!1,d.resolve(e)}else d.resolve(!0)})}catch(b){d.resolve(!0)}else setTimeout(l,500)}(),d.promise},j=function(a){var b={id:a,updatedDate:(new Date).getTime()};g.put({name:"mashCacheAge",keyPath:"id"},b)},k=function(a){var c=b.defer();return function d(){if(h)try{g.executeSql("SELECT * FROM '"+a+"'").then(function(a){c.resolve("N"===a?"":a)})}catch(b){c.resolve("NoCache")}else setTimeout(d,500)}(),c.promise},l=10080;i("mashCacheStart",l).then(function(a){if(a){try{g.clear()}catch(b){}var e=d.getLogObject("mashCasheDelete","Mashup.UI.Core","cacheService","root of cacheService","Stale-Cache",f);c.log("mashCacheDB was stale so deleted.",e),j("mashCacheStart")}});var m=function(a,b,e){var g="";if(b===!0)return g=n(a);if(!e){var h=d.getLogObject("No heartBeatUrl provided","Mashup.UI.Core","cacheService","getHeartBeatUrl","return blank",f);c.warn("useHeartBeatConvention was falsy but no heartBeatUrl provided.",h)}return e},n=function(a){var b="",c=/^(?:([A-Za-z]+):)?(\/{0,3})([0-9.\-A-Za-z]+)(?::(\d+))?(?:\/([^?#]*))?(?:\?([^#]*))?(?:#(.*))?$/,d=c.exec(a);return b=d[1]+":"+d[2]+d[3]+":"+d[4]+"/api/HeartBeat/"};return{dbCache:g,putCache:function(a,b,c){g.put(b,c),j(a)},getCache:function(a){var c=b.defer();return k(a).then(function(a){c.resolve(a)},function(a){c.reject()}),c.promise},getData:function(h,l,n,o,p,q,r){var s=b.defer();return q=m(n,p,q),i(h,o).then(function(b){r=r||q,r=r||n;var i=e.detect(q,r);b&&i?a.get(n,{withCredentials:!0}).success(function(a){try{g.put(l,a),j(h)}catch(b){var e=d.getLogObject("mashCasheDelete","Mashup.UI.Core","cacheService","getData","Error",f);c.error(b,e),indexedDB.deleteDatabase("mashCacheDB"),c.log("IndexedDB error on updating a cache. Deleted database to allow new schema.",e)}s.resolve(a)}).error(function(){e.failed(q,r),k(h).then(function(a){s.resolve(a)})}):k(h).then(function(a){s.resolve(a)})}),s.promise}}}]),mashupApp.service("detectService",["$http","$q","$log","$interval","$filter","$rootScope","utility","sessionService",function(a,b,c,d,e,f,g,h){"use strict";!function(){var a=new ydn.db.Storage("logServiceDB"),b=!1;a.onReady(function(){b=!0,console.log("logServiceDB is ready. [detectService]")});var d=1008e4,e=6048e5;setInterval(function(){!function d(){if(b){var f=(new Date).getTime()-e,i=ydn.db.KeyRange.upperBound(f,!0),j=g.getLogObject("detectManagement:Truncate","Mashup.UI.Core","detectService","anonymous:setInterval",null,h);a.remove("heartbeat",i).done(function(a){j.status=!0,j.count=a,c.log("Truncating old [heartbeat] records.",j)}).fail(function(a){throw j.status=!1,c.log("Truncating old [heartbeat] records. (failed)",j),a})}else setTimeout(d,500)}()},d,0,!1)}(),f.heartBeatMonitorList=[];var i=h.envSession(),j=3e5;i.batteryLevel&&i.batteryLevel<=30&&(j=2*j),d(function(){_.each(f.heartBeatMonitorList,function(b){var c=!0;a.get(b.url,{withCredentials:!0}).success(function(a){c=!0,b.detected=c,k(b.id,c,a)}).error(function(){c=!1,b.detected=c,k(b.id,c),l(b)})})},j,0,!1);var k=function(a,b,d){var f=e("date")((new Date).getTime(),"short"),i="The heartbeat result for '"+a+"' is: [ "+b+" ] at "+f,j=g.getLogObject("HeartBeat","Mashup.UI.Core","detectService","recordHeartBeatResult",b,h);b?(j.msg=i,console.info(angular.fromJson(j))):(j.subject="HeartBeatFail",c.error("HeartBeatFail: "+i,j))},l=function(a){if(!_.where(f.codeBlueList,{id:a.id}).length&&(f.codeBlueList.push(a),!m)){var b=g.getLogObject("StartCodeBlueMonitor","Mashup.UI.Core","detectService","addToCodeBlueList","Starting",h);c.info("Starting up code Blue monitor from heartbeat monitor.",b),n()}};f.codeBlueList=[];var m,n=function(){var b=6e4;i.batteryLevel&&i.batteryLevel<=30&&(b=3*b),m=d(function(){var b=e("date")((new Date).getTime(),"short");if(0===f.codeBlueList.length){d.cancel(m),m=!1;var i=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","startCodeBlueMonitor","ended",h);c.info("codeBlueMonitor ended "+b,i)}else _.each(f.codeBlueList,function(b){var c=!0;a.get(b.url,{withCredentials:!0}).success(function(a){c=!0,b.detected=c,o(b.id,c,a),f.codeBlueList=_.filter(f.codeBlueList,function(a){return a.id!==b.id})}).error(function(){c=!1,b.detected=c,o(b.id,c)})})},b,0,!1)},o=function(a,b,d){var f=e("date")((new Date).getTime(),"short"),i="The code Blue result for "+a+" is: [ "+b+" ] at "+f,j=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","recordCodeBlueResult",b,h);j.webApiName=a,b?c.info(i,j):c.error(i,j)},p=function(a,b){if(!a)return!0;try{var d=_.where(f.heartBeatMonitorList,{id:b});if(0===d.length){var e={id:b,url:a,detected:!0};return f.heartBeatMonitorList.push(e),!0}return d[0].detected}catch(i){var j=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","canDetectHeartBeat","Error",h);j.webApiName=b,j.heartBeatUrl=a,j.error=i,c.error("detectService.canDetectHeartBeat: "+i,j)}return!0};return{detect:function(a,b){return p(a,b)},failed:function(a,b){var d=g.getLogObject("CodeBlueMonitor","Mashup.UI.Core","detectService","detectService.failed",!1,h);if(d.webApiName=b,d.heartBeatUrl=a,c.warn("detectService.failed: A call to Web Api: "+b+" failed",d),!_.where(f.codeBlueList,{id:b}).length){var e={id:b,url:a,detected:!1};f.codeBlueList.push(e)}m||n()}}}]),mashupApp.config(["$provide",function(a){a.decorator("$log",["$delegate","logService",function(a,b){return b(a)}])}]),mashupApp.factory("logService",["$filter","sessionService","utility",function(a,b,c){"use strict";return function(d){var e=1,f=0,g={stores:[{name:"log",keyPath:"logId",autoIncrement:!1},{name:"heartbeat",keyPath:"logId",autoIncrement:!1}]},h=new ydn.db.Storage("logServiceDB",g),i=!1;h.onReady(function(){i=!0,console.log("logServiceDB is ready. [logService]")}),h.addEventListener("error",function(a){var b=a.getError();console.log("connection failed with "+b.name)});var j=function(b,d){var g=(new Date).getTime(),h=c.localMilToUtcMil(g),i=a("date")(g,"short"),j=a("date")(h,"short"),k={msg:b[f],logId:h,dateTimeLocal:i,dateTimeUtc:j,logType:d,transmitted:!1};if(b.length>1)for(var l in b[e])b[e].hasOwnProperty(l)&&(k[l]=b[e][l]);return k},k=function(a,b){!function c(){if(i){if(angular.isString(a[f])){var d=j(a,b),e=d.subject;switch(e){case"Perf":break;case"HeartBeatFail":case"CodeBlueMonitor":h.put({name:"heartbeat"},d);break;case"Debug":break;case"Error":}h.put({name:"log"},d)}}else setTimeout(c,500)}()};return function(){var a=null,d=null,e=b.envSession();"desktop"===e.deviceType?(a=72e5,d=6048e5):(a=18e5,d=1728e5),e.batteryLevel&&e.batteryLevel<=30&&(a=4*a,d=4*d),setInterval(function(){!function a(){if(i){var e=c.localMilToUtcMil((new Date).getTime())-d,f=ydn.db.KeyRange.upperBound(e,!0),g=c.getLogObject("logManagement:Truncate","Mashup.UI.Core","logService","anonymous:setInterval",null,b);h.remove("log",f).done(function(a){g.status=!0,g.count=a,k(["Truncating old [log] records.",g],"log"),console.log(["Truncating old [log] records.",g])}).fail(function(a){throw g.status=!1,k(["Truncating old [log] records. (failed)",g],"log"),console.log(["Truncating old [log] records.",g]),a})}else setTimeout(a,500)}()},a,0,!1)}(),{log:function(){d.log(arguments[f]);try{k(arguments,"log")}catch(a){}},info:function(){d.info(arguments[f]);try{k(arguments,"info")}catch(a){}},error:function(){d.error(arguments[f]);try{k(arguments,"error")}catch(a){}},warn:function(){d.warn(arguments[f]);try{k(arguments,"warn")}catch(a){}}}}}]),mashupApp.service("sessionService",function(){"use strict";var a={};!function(){var b="Unknown OS";-1!==navigator.appVersion.indexOf("Win")&&(b="Windows"),-1!==navigator.appVersion.indexOf("Mac")&&(b="MacOS"),-1!==navigator.appVersion.indexOf("X11")&&(b="UNIX"),-1!==navigator.appVersion.indexOf("Linux")&&(b="Linux"),a.osName=b,a.appVersion=navigator.appVersion}(),function(){var b,c,d,e=navigator.userAgent,f=navigator.appName,g=""+parseFloat(navigator.appVersion),h=parseInt(navigator.appVersion,10);-1!==(c=e.indexOf("Opera"))?(f="Opera",g=e.substring(c+6),-1!==(c=e.indexOf("Version"))&&(g=e.substring(c+8))):-1!==(c=e.indexOf("MSIE"))?(f="Microsoft Internet Explorer",g=e.substring(c+5)):-1!==(c=e.indexOf("Chrome"))?(f="Chrome",g=e.substring(c+7)):-1!==(c=e.indexOf("Safari"))?(f="Safari",g=e.substring(c+7),-1!==(c=e.indexOf("Version"))&&(g=e.substring(c+8))):-1!==(c=e.indexOf("Firefox"))?(f="Firefox",g=e.substring(c+8)):(b=e.lastIndexOf(" ")+1)<(c=e.lastIndexOf("/"))&&(f=e.substring(b,c),g=e.substring(c+1),f.toLowerCase()===f.toUpperCase()&&(f=navigator.appName)),-1!==(d=g.indexOf(";"))&&(g=g.substring(0,d)),-1!==(d=g.indexOf(" "))&&(g=g.substring(0,d)),h=parseInt(""+g,10),isNaN(h)&&(g=""+parseFloat(navigator.appVersion),h=parseInt(navigator.appVersion,10)),a.browserName=f,a.fullVersion=g,a.majorVersion=h}(),function(){var b={Android:function(){return navigator.userAgent.match(/Android/i)},BlackBerry:function(){return navigator.userAgent.match(/BlackBerry/i)},iOS:function(){return navigator.userAgent.match(/iPhone|iPad|iPod/i)},Opera:function(){return navigator.userAgent.match(/Opera Mini/i)},Windows:function(){return navigator.userAgent.match(/IEMobile/i)},any:function(){return b.Android()||b.BlackBerry()||b.iOS()||b.Opera()||b.Windows()}},c="";b.any()?(a.deviceType="mobile",b.Android()&&(c="Android"),b.BlackBerry()&&(c="BlackBerry"),b.iOS()&&(c="iPhone|iPad|iPod"),b.Opera()&&(c="Opera Mini"),b.Windows()&&(c="IEMobile")):a.deviceType="desktop",a.mobileType=c}(),function(){var b=navigator.battery||navigator.webkitBattery||navigator.mozBattery;if(b){var c=function(){a.batteryLevel=100*b.level};b.addEventListener("levelchange",function(a){console.warn("sessionService: Battery level change: ",b.level),c()},!1)}}();var b={};return{getUserSessions:function(){return b.hasOwnProperty("logUserName")||(b.logUserName="unknown-user"),b.hasOwnProperty("logAppName")||(b.logAppName="unknown-app"),b},setUserSession:function(a){return b=a,!0},envSession:function(){return a}}}),mashupApp.service("utility",["utility_UtcDateService","utility_LogHelper",function(a,b){"use strict";var c=a.utcMilToLocalMil,d=a.localMilToUtcMil,e=a.localDateToUtcDate,f=a.utcDateToLocalDate,g=b.getLogObject;return{localDateToUtcDate:e,utcDateToLocalDate:f,localMilToUtcMil:d,utcMilToLocalMil:c,getLogObject:g}}]),mashupApp.service("utility_LogHelper",function(){"use strict";var a=function(a,b,c,d,e,f){var g={subject:a,app:b,module:c,func:d,status:e};try{var h=f.getUserSessions();h.hasOwnProperty("logUserName")?g.logUserName=h.logUserName:g.logUserName="unknown-user-property",h.hasOwnProperty("logAppName")?g.logAppName=h.logAppName:g.logAppName="unknown-app-property"}catch(i){}try{var j=f.envSession();g.osName=j.osName,g.browser=j.browserName+" "+j.fullVersion,"desktop"===j.deviceType?g.deviceType=j.deviceType:g.deviceType=j.deviceType+": "+j.mobileType}catch(i){}return g};return{getLogObject:a}}),mashupApp.service("utility_UtcDateService",function(){"use strict";var a=function(a){var b=new Date;return(new Date).setTime(a-6e4*b.getTimezoneOffset())},b=function(a){var b=new Date;return(new Date).setTime(a+6e4*b.getTimezoneOffset())},c=function(a){return new Date(b(a.getTime()))},d=function(b){return new Date(a(b.getTime()))};return{localDateToUtcDate:c,utcDateToLocalDate:d,localMilToUtcMil:b,utcMilToLocalMil:a}});
//# sourceMappingURL=core.services.min.js.map